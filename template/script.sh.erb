#!/bin/bash
cd "${HOME}"

module purge && module restore

export SHELL="$(getent passwd $USER | cut -d: -f7)"

SING_IMAGE="/appl/opt/ood/$SLURM_OOD_ENV/vnc_images/xfce.sif"
STAGED_ROOT="<%= session.staged_root -%>"

cat /etc/passwd <( singularity exec -B $HOME "$SING_IMAGE" cat /etc/passwd  ) > "$STAGED_ROOT/passwd"

# Bind common CSC environment directories
MOUNTS="$HOME,/appl,/projappl,/scratch"

# Bind TMPDIR if it is set and directory exists
if [ -d "$TMPDIR" ]; then
    MOUNTS="$MOUNTS,$TMPDIR"
fi

# Bind LOCAL_SCRATCH if it is set and directory exists
if [ -d "$LOCAL_SCRATCH" ]; then
    MOUNTS="$MOUNTS,$LOCAL_SCRATCH"
fi

# Bind /fmi if it is set and directory exists
if [ -d "/fmi" ]; then
    MOUNTS="$MOUNTS,/fmi"
fi

# Bind /appl/data
if [ -d "/appl/data" ]; then
    MOUNTS="$MOUNTS,/appl/data"
fi

MOUNTS="$MOUNTS,\
/etc/slurm,\
/usr/bin/srun,\
/usr/bin/sbatch,\
/usr/lib/slurm,\
/usr/lib64/slurm,\
/usr/lib64/libmunge.so.2,\
/opt/pmix,\
/etc/munge,\
$STAGED_ROOT/passwd:/etc/passwd,\
/usr/lib64/lua/5.3,\
/usr/share/lua/5.3,\
/var/run\
"

# To easily mount the same directories for the appcontainers, have APPTAINER_BIND be same inside the container too.
# After Apptainer 1.1.0 (I think) nested container bind mount fix APPTAINER_BIND=/src:/dst turns into
# APPTAINER_BIND=/dst inside the container, which would require us to do "unset SINGULARITY_BIND; unset APPTAINER_BIND",
# and specify mounts again.
export APPTAINER_BIND=$MOUNTS
export APPTAINERENV_APPTAINER_BIND=$MOUNTS
export APPTAINERENV_SINGULARITY_BIND=$MOUNTS

export APPTAINERENV_SHELL=$SHELL
export APPTAINERENV_DISPLAY=$DISPLAY
export APPTAINERENV_TMPDIR=$TMPDIR

# Base env vars for making srun work
export APPTAINERENV_SLURM_OOD_ENV=$SLURM_OOD_ENV
export APPTAINERENV_SLURM_JOB_ID=$SLURM_JOB_ID
export APPTAINERENV_SLURM_MPI_TYPE=$SLURM_MPI_TYPE

# Env vars for running (graphical) apps using srun (possibly containerized)
export APPTAINERENV_SLURM_EXPORT_ENV="\
HOME,DISPLAY,TERM,LC_ALL,LC_CTYPE,\
SINGULARITY_NAME,SINGULARITY_BIND,APPTAINER_BIND,\
XDG_CONFIG_HOME,XDG_DESKTOP_DIR,XDG_DATA_HOME,XDG_DATA_DIRS,XDG_RUNTIME_DIR\
"

unset SING_FLAGS

singularity exec \
  --cleanenv \
  $SING_IMAGE \
  bash -cl "$STAGED_ROOT/desktops/xfce.sh"
