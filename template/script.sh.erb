#!/bin/bash
cd "${HOME}"

module purge && module restore

export SHELL="$(getent passwd $USER | cut -d: -f7)"
mkdir -p $XDG_DESKTOP_DIR

# TODO: Fix this for LUMI
'''
# Bind TMPDIR if it is set and directory exists
if [ -d "$TMPDIR" ]; then
    SING_FLAGS="$SING_FLAGS -B $TMPDIR:$TMPDIR"
fi

# Bind LOCAL_SCRATCH if it is set and directory exists
if [ -d "$LOCAL_SCRATCH" ]; then
    SING_FLAGS="$SING_FLAGS -B $LOCAL_SCRATCH:$LOCAL_SCRATCH"
fi

# Bind /fmi if it is set and directory exists
if [ -d "/fmi" ]; then
    SING_FLAGS="$SING_FLAGS -B /fmi:/fmi"
fi

# Bind /appl/data
if [ -d "/appl/data" ]; then
    SING_FLAGS="$SING_FLAGS -B /appl/data:/appl/data"
fi
'''

<% sing_image = File.join("/appl/local/ood","#{ENV["SLURM_OOD_ENV"]}","vnc_images/xfce.sif") -%>

cat /etc/passwd <( singularity exec -B $HOME "<%= sing_image %>" cat /etc/passwd  ) > "<%= File.join(session.staged_root, "passwd") %>"

singularity exec -B /pfs,/scratch,/project,/projappl,/flash,/etc/slurm/ -B /usr/bin/srun,/usr/bin/sbatch -B /usr/lib64/slurm/ -B /usr/lib64/libmunge.so.2 -B /etc/munge/,<%= File.join(session.staged_root, "passwd") %>:/etc/passwd,/usr/lib64/lua/5.3/,/var/run,/usr/share/lua/5.3 "<%= sing_image %>" bash -cl "<%= File.join(session.staged_root, "desktops/xfce.sh") %>"
