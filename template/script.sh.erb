cd "${HOME}"

module purge && module restore
/appl/opt/ood/test/soft/ssh-keygen.sh

export SHELL="$(getent passwd $USER | cut -d: -f7)"
export XDG_CONFIG_HOME="<%= session.staged_root.join("config") %>"
export XDG_DESKTOP_DIR="<%= session.staged_root.join("Desktop") %>"

echo "Launching desktop <%= context.desktop %> with app <%= context.app %>"

desktop_script="<%= session.staged_root.join("desktops", context.desktop.empty? ? "nodesktop.sh" : "#{context.desktop}.sh") -%>"
app_script="<%= session.staged_root.join("apps", "#{context.app}.sh") -%>"
app="<%= context.app %>"
export SING_FLAGS="$SING_FLAGS -B /tmp/$USER/$SLURM_JOB_ID/.ssh/config:$HOME/.ssh/config,/tmp/$USER/$SLURM_JOB_ID/.ssh/id_rsa_puhti_ood:$HOME/.ssh/id_rsa_puhti_ood"

<% if context.desktop.empty? %>
  singularity exec $SING_FLAGS $SING_IMAGE "$desktop_script" &
  if [[ -z "$app" ]];then
    xterm
  else
    exec "$app_script"
  fi
<% else %>
  if [[ -n "$app" ]];then
    exec "$app_script" &
  fi
  singularity exec $SING_FLAGS $SING_IMAGE "$desktop_script"
<% end %>


sed -i "/puhti-ood-$SLURM_JOB_ID/d" ~/.ssh/authorized_keys
rm -rf /tmp/$USER/$SLURM_JOB_ID/.ssh/
