#!/bin/bash
cd "${HOME}"

module purge && module restore

export SHELL="$(getent passwd $USER | cut -d: -f7)"
export XDG_DESKTOP_DIR=$HOME/Desktop
mkdir -p $XDG_DESKTOP_DIR

<% sing_image = File.join("/appl/local/ood","#{ENV["SLURM_OOD_ENV"]}","container_images/xfce.sif") -%>

cat /etc/passwd <( singularity exec -B $HOME "<%= sing_image %>" cat /etc/passwd  ) > "<%= File.join(session.staged_root, "passwd") %>"

singularity exec -B /pfs,/scratch,/project,/projappl,/flash,/appl,/etc/slurm/ -B /usr/bin/srun,/usr/bin/sbatch -B /usr/lib64/slurm/ -B /usr/lib64/libmunge.so.2 -B /etc/munge/,<%= File.join(session.staged_root, "passwd") %>:/etc/passwd,/usr/lib64/lua/5.3/,/var/run,/usr/share/lua/5.3 "<%= sing_image %>" bash -cl "<%= File.join(session.staged_root, "desktops/xfce.sh") %>"
