<% sing_image = desktop.empty? ? File.join("/appl","opt","ood","#{ENV["SLURM_OOD_ENV"]}","vnc_images", "xfce.sif") : File.join("/appl", "opt", "ood", "#{ENV["SLURM_OOD_ENV"]}", "vnc_images", "#{desktop}.sif") -%>
---
cluster: "<%= ENV["CSC_CLUSTER"] -%>"

<% max_mem_per_cpu = SlurmLimits.limits.fetch(csc_slurm_partition, {}).fetch(:max_mem_per_cpu, 0).to_f %>
<% mem = (max_mem_per_cpu * 1024 * csc_cores.to_i).to_i %>

batch_connect:
  template: vnc
  header: |
    source /appl/profile/zz-csc-env.sh
    [[ $(type -t module) == "function" ]] & export -f module
    export XDG_RUNTIME_DIR="$TMPDIR/xdg_runtime"
    mkdir -p -m 700 "$XDG_RUNTIME_DIR"
    export PATH="$PWD/bin:$PATH"
    export SING_IMAGE="<%= sing_image -%>"
    export SING_FLAGS="--nv -B $HOME -B /etc/ssh -B /tmp:/tmp -B /run:/run -B /appl:/appl -B <%= "#{File.join(staged_root, "Desktop")}:/usr/local/share/applications:ro" -%>"
  websockify_cmd: 'singularity_wrapper exec /opt/websockify/run'
script:
  native:
    - '-c'
    - '<%= csc_cores %>'
    - '-t'
    - '<%= csc_time %>'
    <% if max_mem_per_cpu > 0 %>
    - '--mem=<%= mem -%>M'
    <% else %>
    - '--mem=<%= csc_memory -%>G'
    <% end %>
    <% if csc_nvme.to_i > 0 %>
    - '--gres=nvme:<%= csc_nvme.to_i -%>'
    <% end %>
