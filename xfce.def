Bootstrap: docker
From: rockylinux:8.8

%environment 
  SHELL=/bin/bash
  export SHELL
  export "PATH=/opt/TurboVNC/bin:${PATH}"
  # https://stackoverflow.com/questions/2499794/how-to-fix-a-locale-setting-warning-from-perl
  export LC_CTYPE=en_US.UTF-8
  export LC_ALL=en_US.UTF-8

%files
  applications/firefox.desktop /usr/share/applications/firefox.desktop

%post 
    export FIREFOX_VERSION="115.8.0esr"
    export TURBOVNC_VERSION=2.2.6

    # Only here to allow rootless building of container
    cp /usr/bin/true /usr/sbin/groupadd
    cp /usr/bin/true /usr/sbin/useradd
    dnf -y install unbound-libs

    dnf -y install libnsl
    dnf -y install dnf-plugins-core
    yum -y install epel-release
    dnf -y install emacs
    dnf -y install gedit
    dnf -y install glibc-all-langpacks    
    dnf -y config-manager --set-enabled powertools
    dnf -y update
    dnf -y install glibc-all-langpacks
    dnf -y install hwloc
    yum -y install Lmod
    yum -y install xorg-x11-fonts-Type1 xorg-x11-fonts-misc
    yum -y install libglvnd-opengl
    yum install -y freeglut-devel
    dnf -y groupinstall "xfce"

    yum -y install xterm
    yum -y install xkeyboard-config
    yum -y install hostname
    yum -y install which
    yum -y install python3
    yum -y install python3-pip
    yes | pip3 install numpy
    yum -y install xkbcomp
    yum -y install xorg-x11-xkb-utils
    yum -y install xauth
    yum -y install wget
    yum -y install tar
    yum -y install xz
    yum install -y \
    less \
    vim \
    libxkbcommon-x11 \
    libglvnd \
    libXv \
    xorg-x11-server-Xvfb \
    tcsh \
    motif \
    libXp \
    libXpm \
    xterm \
    git \
    xdg-user-dirs

    wget http://www.TurboVNC.org/key/VGL-GPG-KEY
    rpm --import VGL-GPG-KEY
    yum -y install git
    wget --no-check-certificate https://sourceforge.net/projects/turbovnc/files/${TURBOVNC_VERSION}/turbovnc-${TURBOVNC_VERSION}.x86_64.rpm
    yum -y install turbovnc-${TURBOVNC_VERSION}.x86_64.rpm 
    rm turbovnc-${TURBOVNC_VERSION}.x86_64.rpm 
    mkdir -p /opt/websockify
    wget https://github.com/novnc/websockify/archive/master.tar.gz -q -O - | tar xzf - -C /opt/websockify --strip-components=1

    # Firefox
    dnf -y install alsa-lib atk bzip2 cairo cairo-gobject dbus-glib dbus-libs fontconfig freetype \
                   gdk-pixbuf2 glib2 glibc gtk3 gtk-update-icon-cache libffi libgcc libstdc++ libX11 \
                   libX11-xcb libxcb libXcomposite libXcursor libXdamage libXext libXfixes libXi \
                   libXrandr libXrender libXtst nspr nss nss-util p11-kit-trust pango pciutils-libs zlib
    mkdir -p /opt/firefox
    wget https://download-installer.cdn.mozilla.net/pub/firefox/releases/${FIREFOX_VERSION}/linux-x86_64/en-US/firefox-${FIREFOX_VERSION}.tar.bz2 -q -O - | tar xfj - -C /opt/firefox --strip-components=1
    ln -s /opt/firefox/firefox /usr/bin/firefox
    for size in 16 32 48 64 128; do ln -s "/opt/firefox/browser/chrome/icons/default/default${size}.png" "/usr/share/icons/hicolor/${size}x${size}/apps/firefox.png"; done
    touch /usr/share/icons/hicolor
    gtk-update-icon-cache
    yum clean all && rm -rf /var/cache/yum
    dbus-uuidgen > /etc/machine-id

    # Hide the non-host terminal
    echo -e '#!/bin/bash\n
if [[ -z "$@" ]];then
    srun --jobid=$SLURM_JOB_ID --overlap --pty /usr/bin/bash -c "unset \$(compgen -v | grep SLURM_ | grep -vE \"SLURM_JOB_|SLURM_OOD_ENV\"); exec /bin/bash -l"
else
    srun --jobid=$SLURM_JOB_ID --overlap --pty /usr/bin/bash -lc "unset \$(compgen -v | grep SLURM_ | grep -vE \"SLURM_JOB_|SLURM_OOD_ENV\"); $(printf "%q " "$@")"
fi
[ $? -ne 0 ] && read
' > /usr/bin/host_terminal
    chmod +x /usr/bin/host_terminal
    cp /usr/bin/xterm /usr/bin/real-xterm
    cp /usr/bin/xfce4-terminal /usr/bin/real-xfce4-terminal
    echo -e '#!/bin/bash\n/usr/bin/real-xterm -e "bash /usr/bin/host_terminal"' > /usr/bin/xterm
    echo -e '#!/bin/bash
for arg do
  shift
  [ "$arg" = "-x" ] && continue
  set -- "$@" "$arg"
done
/usr/bin/real-xfce4-terminal -e "/usr/bin/host_terminal $(printf "%q " "$@")"' > /usr/bin/xfce4-terminal
